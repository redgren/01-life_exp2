---
title: "Week 11 Class Notes"
author: "Richard Ressler"
date: "4/6/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, load_libs}
library(tidyverse)
library(broom)
library(gapminder)
```


```{r}
data(gapminder)
glimpse(gapminder)
```

```{r}
gapminder %>% 
  ggplot(aes(x = year, y = lifeExp, group = country, color = continent))+
  geom_line(alpha= 1/3) +
  xlab("Year") +
  ylab("Life Expectancy")
```

```{r}
gapminder %>% 
  filter(country == "United States") ->
  usdf

ggplot(usdf, aes(year, lifeExp)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
   xlab("Year") +
  ylab("Life Expectancy")

```

```{r}
us_mout <- lm(lifeExp ~ year, data = usdf)
tidy_uslm <- tidy(us_mout, conf.int = TRUE)
tidy_uslm
summary(us_mout)
```

```{r}
plot(us_mout)
```

```{r}
gapminder %>% 
  mutate(logpop = log2(pop)) ->
  gapminder
```

```{r}
ggplot(gapminder, aes(year, logpop, group = country, color = continent)) +
  geom_line(alpha = 1/3) +
   xlab("Year") +
  ylab("Log Population")
```

```{r}
gapminder %>% 
  filter(country == "China") ->
  china_df

china_df %>% 
  ggplot(aes(year, logpop)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm") 
```
```{r}
china_lm <- lm(logpop ~ year, data = china_df)
tidy(china_lm, conf.int = TRUE)
plot(china_lm)
2^0.02319115
```

# Nested Data Frames
```{r}
gapminder %>% 
  group_by(country, continent) %>% 
  nest() ->
  nested_gap_df
nested_gap_df
```

```{r}
nested_gap_df$data[[1]]
```

```{r}
nested_gap_df$data[[2]]
```

```{r}
str(nested_gap_df$data[[1]])
```

```{r}
nested_gap_df[[24,3]]
```

```{r}
usind <- which(nested_gap_df$country == "United States")
usind
nested_gap_df$data[[usind]]
nested_gap_df[[which(nested_gap_df$country == "United States"), 3]]
```
# Fit Many Models Using purrr::map

```{r}
nested_gap_df %>% 
  mutate(lmout = map(data, ~lm(lifeExp ~ year, data = .))) ->
  nested_gap_df
nested_gap_df
nested_gap_df$lmout[[1]]
summary(nested_gap_df$lmout[[2]])
```

```{r}
nested_gap_df %>% 
  mutate(lmpop = map(data, ~lm(logpop ~ year, data = .))) ->
  nested_gap_df
nested_gap_df
nested_gap_df$lmpop[[1]]
summary(nested_gap_df$lmpop[[2]])
```

```{r}
str(tidy(us_mout, conf.int = TRUE))
str(summary(us_mout))
```

```{r}
str(glance(us_mout))
```

```{r}
augment(us_mout)
```

```{r}
nested_gap_df %>% 
  mutate(tidyout = map(lmout, ~tidy(., conf.int = TRUE)),
         augmentout = map(lmout, augment),
         glanceout = map(lmout, glance)) ->
  nested_gap_df
nested_gap_df
```

```{r}
nested_gap_df %>% 
  filter(continent =="Asia") %>% 
  head()
```

```{r}
nested_gap_df$tidyout[[1]]
```

```{r}
nested_gap_df %>% 
  mutate(tidypop = map(lmpop, ~tidy(., conf.int = TRUE))) ->
  nested_gap_df
nested_gap_df
nested_gap_df[[which(nested_gap_df$country == "China"), which(names(nested_gap_df)== "tidypop")]]
tidy(china_lm, conf.int = TRUE)

```

# Extract with unnest()

```{r}
unnest(nested_gap_df, tidyout) %>% 
  ungroup() ->
  model_summary_df
model_summary_df
```

```{r}
library(ggthemes)
model_summary_df %>%
  filter(term == "year") %>%
  mutate(country = fct_reorder(country, estimate)) %>%
  ggplot(aes(x = country, y = estimate, color = continent)) +
  geom_point() +
  geom_segment(aes(x = country, xend = country, y = conf.low, yend = conf.high), 
               color = "black", 
               alpha = 1/3) +
  ylab("Estimate of Rate of Life Expectancy Increase") +
  xlab("Country") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  scale_color_colorblind()
```

```{r}
unnest(nested_gap_df, augmentout)->
  augment_df
augment_df
augment_df %>%
  ggplot(aes(x = year, y = .resid, group = country)) +
  geom_line(alpha = 1/3) +
  facet_wrap(.~continent) +
  geom_hline(yintercept = 0, lty = 2, col = "blue") +
  xlab("Residuals") +
  ylab("Year")
```

```{r}
unnest(nested_gap_df, tidypop)->
  tpop
tpop %>% 
  filter(term == "year") %>% 
  arrange(estimate)->
  tpop
tpop %>% 
  select(country, estimate) %>% 
  head()
tpop %>% 
  select(country, estimate) %>% 
  tail()
2^0.06990665	
```

```{r}
nested_gap_df
```

```{r}
nested_gap_df %>% 
  select(country, continent, glanceout) %>% 
  unnest(glanceout) %>% 
  ungroup() ->
  df_glance
df_glance
```

```{r}
df_glance %>% 
  ggplot(aes(x = continent, y = r.squared)) +
  geom_jitter()
```

```{r}
bad_fit <- filter(df_glance, r.squared <0.5)

gapminder %>% 
  semi_join(bad_fit, by = "country") %>% 
  ggplot(aes(year, lifeExp, color = country)) +
  geom_line()
```

```{r}
mtcars %>% 
  group_by(cyl) %>% 
  nest() %>% 
  mutate(lmout= map(data, ~lm(mpg ~ wt, data = .))) %>% 
  mutate(tidyout = map(lmout, ~tidy(.))) %>% 
  unnest(tidyout) %>% 
  filter(term == "wt") %>% 
  select(cyl, estimate)
```

# COVID Lab

## Get the data files
```{r}
url_in <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"	

file_names <- c("time_series_covid19_confirmed_US.csv",
                "time_series_covid19_confirmed_global.csv",
                "time_series_covid19_deaths_US.csv",
                "time_series_covid19_deaths_global.csv")
#file_names
df <- tibble(case_type = as.factor(str_extract(file_names, "[:alpha:]*_[gU][:alpha:]*")))
df
#read in data
for (i in seq_along(file_names)){
  df$data[[i]] <- read_csv(str_c(url_in, file_names[i], collapse = "", na = ""))
}
df

```

```{r}
#get names
df$vars <- map(df$data, names)
```


```{r clean_data_names, echo = params$solutions}
for ( i in seq_along(file_names)){
   names(df$data[[i]]) <- str_replace_all(names(df$data[[i]]),"([ey])/","\\1_")
   names(df$data[[i]]) <- str_replace_all(names(df$data[[i]]),"Admin2","County")
   names(df$data[[i]]) <- str_replace_all(names(df$data[[i]]),"Long_","Long")
   if(str_detect(df$case_type[i],"US")){
    df$data[[i]] <- df$data[[i]] <- select(df$data[[i]], -c("UID", "iso2", "iso3", "code3", "FIPS", "Combined_Key"))
   }
   if(!str_detect(names(df$data[[i]]),"Population")){
     df$data[[i]]$Population <- 0
   }
   if(!str_detect(names(df$data[[i]]),"County")){
     df$data[[i]]$County <- "None"
   }
   #df$data[[i]]$Type <- df$case_type[i]
   df$data[[i]] <- unite(df$data[[i]], "Country_State",
                                    c("Country_Region","Province_State"),
                                     na.rm = TRUE, remove = FALSE)
   
}
df$vars <- map(df$data, names)
```


```{r tidy_data, echo = params$solutions}
library(lubridate)
df$vars <- map(df$data,  names)
for ( i in seq_along(file_names)){
df$data[[i]] <- 
    pivot_longer(df$data[[i]], cols = contains("/"), names_to = "Date", values_to = "Daily_Total") 
df$data[[i]]$Date <- mdy(df$data[[i]]$Date)
}
nrow(df$data[[3]])
```

```{r}
library(countrycode)
```

```{r add_continents, echo = params$solutions}
for ( i in seq_along(file_names)){
df$data[[i]]$continent = countrycode(df$data[[i]]$Country_Region, origin = "country.name",
                    destination = "continent") 
print(unique(df$data[[i]]$continent))
print(unique(df$data[[i]]$Country_Region[is.na(df$data[[i]]$continent)]))
}
```

```{r}
    
  for ( i in seq_along(file_names)){
        df$data[[i]]$continent <-  case_when(
        df$data[[i]]$Country_Region == "Diamond Princess" ~ "Asia",
        df$data[[i]]$Country_Region == "MS Zaandam" ~ "Americas",
        df$data[[i]]$Country_Region == "Kosovo" ~ "Europe",
        TRUE ~ df$data[[i]]$continent)
      print(unique(df$data[[i]]$continent))
    }

```

    ```{r}
    df_all <- unnest(df, cols=data) %>% 
      ungroup()
    rm(df)
    df_all <- select(df_all, -vars)
    ```
## Read in World population data for 2019
- CSV provided or you can go to the UN source
- CSV has a few changes in coutnry names to match the COVID data, e.g., US, Iran
    ```{r, read_pop_data}
    df_pop <- read_csv("./WPP2019_TotalPopulation.csv")
    df_pop
    ```

## Add population data to data frame
- Adds popuation and population density
    ```{r, add_pop_data}
    df_all %>% 
      left_join(df_pop, by = c("Country_Region"= "Location") ) %>% 
        ungroup() -> df_all
    ```

## Create a data frame with total confirmed cases by Country/Region and Continent.
+ What are the 25 Countries with the most confirmed cases and most deaths and what is the percentage of their total population affected?

    ```{r top_25, echo = FALSE}
    df_all %>% 
      group_by(Country_Region, continent, case_type) %>%
      summarize(total = sum(max(Daily_Total)), per_pop = total/max(PopTotal, Population)) %>%
      ungroup() -> df_country_state
      
    df_country_state %>%
      filter(case_type %in% c("confirmed_global")) %>% 
      arrange(desc(total)) %>%
      slice(1:25) ->
      top_25_cases
    
      df_country_state %>%
      filter(case_type %in% c("deaths_global"))  %>% 
      arrange(desc(total)) %>%
      slice(1:25) ->
      top_25_deaths
    top_25_cases
    top_25_deaths
    
    
    ```

## Plot the number of cases/deaths over time for the top 25 country/states faceting by continent.  Use appropriate scales for the axes.
- Two sets of plots
    ```{r plot_top_25, echo = FALSE, warning = FALSE}
    
    # grab top 25 country / states for graphing
    df_all %>% 
      group_by(case_type, Country_Region, continent, Date) %>% 
      summarize(country_total = sum(Daily_Total)) ->
      df_summary_country
    
    plot_data <- right_join(df_summary_country, top_25_cases)
    plot_data %>% 
      ggplot(aes(x = Date, y = country_total, 
                 group = Country_Region, 
                 color = Country_Region)) +
        geom_line() +
       facet_wrap(~continent, scales = "free") +
        scale_y_log10() +
        guides(color = guide_legend(ncol = 5)) +
       theme(legend.position="bottom",axis.text.x = element_text(angle = 90))
    
    plot_data <- right_join(df_summary_country, top_25_deaths)
    plot_data %>% 
      ggplot(aes(x = Date, y = country_total, 
                 group = Country_Region, 
                 color = Country_Region)) +
        geom_line() +
       facet_wrap(~continent, scales = "free") +
        scale_y_log10() +
        guides(color = guide_legend(ncol = 5)) +
       theme(legend.position="bottom",axis.text.x = element_text(angle = 90))
    ```
